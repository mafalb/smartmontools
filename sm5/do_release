#!/bin/bash -ev
#
# do a smartmontools release
# (c) 2003 Guido Guenther <agx@sigxcpu.org>

if [ -f /etc/redhat-release ]; then
  RPM_BASE=/usr/src/redhat/
else
  RPM_BASE=/usr/src/rpm/
fi
SRPMS=$RPM_BASE/SOURCES/

setup_cvs()
{
  CVS_SERVER=helloworld
  unset CVS_SERVER || echo "can't unset CVS_SERVER=$CVS_SERVER"
  CVS_RSH=ssh
  CVSROOT=:ext:ballen4705@cvs.smartmontools.sourceforge.net:/cvsroot/smartmontools
}

get_release()
{
  VERSION=`grep '^ *VERSION=' configure | awk -F= '{ print $2 }'`
  RELEASE="RELEASE_${VERSION//\./_}"
  echo "Version: $VERSION"
  echo "Release: $RELEASE"
}

inc_release()
{
  MINOR=`echo $VERSION | cut -d. -f2`
  MAJOR=`echo $VERSION | cut -d. -f1`
  PERL_OLD=$MAJOR\\.$MINOR
  ((MINOR++))
  NEW_VERSION=$MAJOR.$MINOR
  PERL_NEW=$MAJOR\\.$MINOR	
  NEW_RELEASE="RELEASE_${NEW_VERSION//\./_}"
  echo "New Version: $NEW_VERSION"
  echo "New Release: $NEW_RELEASE"
}

# run automake/autoconf
./autogen.sh

get_release

# tag CVS version
setup_cvs
echo cvs commit -m "Release $VERSION"
echo cvs tag -d $RELEASE 
echo cvs tag $RELEASE

# build .tar.gz
rm -rf build
mkdir build
cd build
../configure
make dist
cd ..
cp build/smartmontools-$VERSION.tar.gz $SRPMS

# build rpm
rpm -ba smartmontools.spec

# remove source tarball
rm -f $SRPMS/smartmontools-$VERSION.tar.gz

# increase release number:
inc_release
perl -p -i.bak -e "s/$PERL_OLD/$PERL_NEW/" configure.in
perl -p -i.bak -e "s/Version:\t$PERL_OLD/Version:\t$PERL_NEW/" smartmontools.spec

mv -f $RPM_BASE/RPMS/i386/smartmontools-$VERSION-*.i386.rpm .
mv -f $RPM_BASE/SRPMS/smartmontools-$VERSION-*.src.rpm .
cp -f build/smartmontools-$VERSION.tar.gz .

# cleanup
rm -rf autom4te.cache build/ config.h.in Makefile.in examplescripts/Makefile.in \
       depcomp mkinstalldirs install-sh configure aclocal.m4 missing *.bak


# TARBALL PROBLEMS on redhat:
# if you do ./configure && make && make install:
# make install: puts executables in wrong place on redhat: /usr/local/sbin not /usr/sbin
# puts smartd.conf in /usr/local/etc
# puts man pages in /usr/local/man
# puts doc in /usr/local/share/doc
# puts smartd.conf into a subdirectory of doc file called examples
# puts init scripts into /usr/local/etc/...
